/**
 * @file Overview
 * This ruleset enforces a strict user-ownership model for patient and doctor data,
 * allowing users to only access their own profiles and associated data (appointments, health records).
 * WebRTC call signaling data is accessible to any authenticated user.
 *
 * Data Structure:
 * - /patients/{patientId}: Patient profile information, accessible only to the patient.
 * - /doctors/{doctorId}: Doctor profile information, accessible only to the doctor.
 * - /patients/{patientId}/appointments/{appointmentId}: Appointments for a patient, accessible only to the patient.
 * - /doctors/{doctorId}/appointments/{appointmentId}: Appointments for a doctor, accessible only to the doctor.
 * - /patients/{patientId}/healthRecords/{healthRecordId}: Health records for a patient, accessible only to the patient.
 * - /calls/{callId}: WebRTC call signaling data, accessible to any authenticated user.
 * - /calls/{callId}/offerCandidates/{candidateId}: ICE candidates from the caller, accessible to any authenticated user.
 * - /calls/{callId}/answerCandidates/{candidateId}: ICE candidates from the callee, accessible to any authenticated user.
 *
 * Key Security Decisions:
 * - User listing is disallowed for both patients and doctors.
 * - WebRTC signaling data is open to authenticated users to facilitate call setup.
 * - Default security posture for ambiguous relationships is strict owner-only access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to patient profile information.
     * @path /patients/{patientId}
     * @allow (create) - Authenticated user creating their own profile (patientId matches auth.uid).
     * @allow (get, update, delete) - Authenticated user accessing their own profile (patientId matches auth.uid).
     * @deny (create) - Authenticated user attempting to create a profile with a mismatched patientId.
     * @deny (get, update, delete) - Authenticated user attempting to access another user's profile.
     * @principle Enforces document ownership for reads and writes.
     */
    match /patients/{patientId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(patientId);
      allow list: if false;

      allow create: if isOwner(patientId) && request.resource.data.id == patientId;
      allow update: if isExistingOwner(patientId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(patientId);
    }

    /**
     * @description Controls access to doctor profile information.
     * @path /doctors/{doctorId}
     * @allow (create) - Authenticated user creating their own profile (doctorId matches auth.uid).
     * @allow (get, update, delete) - Authenticated user accessing their own profile (doctorId matches auth.uid).
     * @deny (create) - Authenticated user attempting to create a profile with a mismatched doctorId.
     * @deny (get, update, delete) - Authenticated user attempting to access another user's profile.
     * @principle Enforces document ownership for reads and writes.
     */
    match /doctors/{doctorId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(doctorId);
      allow list: if false;

      allow create: if isOwner(doctorId) && request.resource.data.id == doctorId;
      allow update: if isExistingOwner(doctorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(doctorId);
    }

    /**
     * @description Controls access to appointments associated with a specific patient.
     * @path /patients/{patientId}/appointments/{appointmentId}
     * @allow (create, get, list, update, delete) - Authenticated user who is the patient (patientId matches auth.uid).
     * @deny (create, get, list, update, delete) - Authenticated user attempting to access another user's appointments.
     * @principle Enforces document ownership for reads and writes.
     */
    match /patients/{patientId}/appointments/{appointmentId} {
      function isOwner(patientId) {
        return request.auth != null && request.auth.uid == patientId;
      }
      function isExistingOwner(patientId) {
        return isOwner(patientId) && resource != null;
      }

      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);

      allow create: if isOwner(patientId) && request.resource.data.patientId == patientId;
      allow update: if isExistingOwner(patientId) && request.resource.data.patientId == resource.data.patientId;
      allow delete: if isExistingOwner(patientId);
    }

    /**
     * @description Controls access to appointments associated with a specific doctor.
     * @path /doctors/{doctorId}/appointments/{appointmentId}
     * @allow (create, get, list, update, delete) - Authenticated user who is the doctor (doctorId matches auth.uid).
     * @deny (create, get, list, update, delete) - Authenticated user attempting to access another user's appointments.
     * @principle Enforces document ownership for reads and writes.
     */
    match /doctors/{doctorId}/appointments/{appointmentId} {
      function isOwner(doctorId) {
        return request.auth != null && request.auth.uid == doctorId;
      }
      function isExistingOwner(doctorId) {
        return isOwner(doctorId) && resource != null;
      }

      allow get: if isOwner(doctorId);
      allow list: if isOwner(doctorId);

      allow create: if isOwner(doctorId) && request.resource.data.doctorId == doctorId;
      allow update: if isExistingOwner(doctorId) && request.resource.data.doctorId == resource.data.doctorId;
      allow delete: if isExistingOwner(doctorId);
    }

    /**
     * @description Controls access to health records associated with a specific patient.
     * @path /patients/{patientId}/healthRecords/{healthRecordId}
     * @allow (create, get, list, update, delete) - Authenticated user who is the patient (patientId matches auth.uid).
     * @deny (create, get, list, update, delete) - Authenticated user attempting to access another user's health records.
     * @principle Enforces document ownership for reads and writes.
     */
    match /patients/{patientId}/healthRecords/{healthRecordId} {
      function isOwner(patientId) {
        return request.auth != null && request.auth.uid == patientId;
      }
      function isExistingOwner(patientId) {
        return isOwner(patientId) && resource != null;
      }

      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);

      allow create: if isOwner(patientId) && request.resource.data.patientId == patientId;
      allow update: if isExistingOwner(patientId) && request.resource.data.patientId == resource.data.patientId;
      allow delete: if isExistingOwner(patientId);
    }

    /**
     * @description Controls access to WebRTC call signaling data.
     * @path /calls/{callId}
     * @allow (create, get, list, update, delete) - Any authenticated user can access.
     * @principle Allows any authenticated user to create or join a call.
     */
    match /calls/{callId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to ICE candidates from the caller.
     * @path /calls/{callId}/offerCandidates/{candidateId}
     * @allow (create, get, list, update, delete) - Any authenticated user can add candidates.
     */
    match /calls/{callId}/offerCandidates/{candidateId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to ICE candidates from the callee.
     * @path /calls/{callId}/answerCandidates/{candidateId}
     * @allow (create, get, list, update, delete) - Any authenticated user can add candidates.
     */
    match /calls/{callId}/answerCandidates/{candidateId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow list: if isSignedIn();

      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }
}