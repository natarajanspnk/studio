/**
 * @fileoverview Firestore Security Rules for MediConnect Platform
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for Patients and Doctors data.
 * Only authenticated users can access their own profile data and associated records.
 *
 * Data Structure:
 * - /patients/{patientId}: Stores patient profile information.
 * - /doctors/{doctorId}: Stores doctor profile information.
 * - /patients/{patientId}/appointments/{appointmentId}: Stores appointments for a specific patient.
 * - /doctors/{doctorId}/appointments/{appointmentId}: Stores appointments for a specific doctor.
 * - /patients/{patientId}/healthRecords/{healthRecordId}: Stores health records for a specific patient.
 *
 * Key Security Decisions:
 * - Users can only access their own data (patients can only access their patient profile, doctors their doctor profile).
 * - Listing of user documents is allowed only to the owner.
 * - Authorization is based on `request.auth.uid` matching the document ID in the path.
 * - Data shape is NOT validated in this Prototyping phase.
 *
 * Denormalization for Authorization:
 * - Appointments and HealthRecords subcollections include `patientId` or `doctorId` to allow for direct authorization checks without requiring `get()` calls to the parent document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows authenticated users to manage their own patient profile.
     * @path /patients/{patientId}
     * @allow (create, update, delete) if request.auth.uid == patientId
     * @allow (get, list) if request.auth.uid == patientId
     * @deny (create, update, delete) if request.auth.uid != patientId
     * @principle Enforces document ownership for patient profiles.
     */
    match /patients/{patientId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isExistingOwner(patientId);
      allow delete: if isExistingOwner(patientId);
    }

    /**
     * @description Allows authenticated users to manage their own doctor profile.
     * @path /doctors/{doctorId}
     * @allow (create, update, delete) if request.auth.uid == doctorId
     * @allow (get, list) if request.auth.uid == doctorId
     * @deny (create, update, delete) if request.auth.uid != doctorId
     * @principle Enforces document ownership for doctor profiles.
     */
    match /doctors/{doctorId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(doctorId);
      allow list: if isOwner(doctorId);
      allow create: if isOwner(doctorId);
      allow update: if isExistingOwner(doctorId);
      allow delete: if isExistingOwner(doctorId);
    }

    /**
     * @description Allows authenticated patients to manage their own appointments.
     * @path /patients/{patientId}/appointments/{appointmentId}
     * @allow (create, update, delete) if request.auth.uid == patientId
     * @allow (get, list) if request.auth.uid == patientId
     * @deny (create, update, delete) if request.auth.uid != patientId
     * @principle Enforces document ownership for patient appointments.
     */
    match /patients/{patientId}/appointments/{appointmentId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isExistingOwner(patientId);
      allow delete: if isExistingOwner(patientId);
    }

     /**
      * @description Allows authenticated doctors to manage their own appointments.
      * @path /doctors/{doctorId}/appointments/{appointmentId}
      * @allow (create, update, delete) if request.auth.uid == doctorId
      * @allow (get, list) if request.auth.uid == doctorId
      * @deny (create, update, delete) if request.auth.uid != doctorId
      * @principle Enforces document ownership for doctor appointments.
      */
    match /doctors/{doctorId}/appointments/{appointmentId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(doctorId);
      allow list: if isOwner(doctorId);
      allow create: if isOwner(doctorId);
      allow update: if isExistingOwner(doctorId);
      allow delete: if isExistingOwner(doctorId);
    }


    /**
     * @description Allows authenticated patients to manage their own health records.
     * @path /patients/{patientId}/healthRecords/{healthRecordId}
     * @allow (create, update, delete) if request.auth.uid == patientId
     * @allow (get, list) if request.auth.uid == patientId
     * @deny (create, update, delete) if request.auth.uid != patientId
     * @principle Enforces document ownership for patient health records.
     */
    match /patients/{patientId}/healthRecords/{healthRecordId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isExistingOwner(patientId);
      allow delete: if isExistingOwner(patientId);
    }
  }
}