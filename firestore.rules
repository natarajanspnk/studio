/**
 * @fileoverview Firestore Security Rules for MediConnect Platform
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for Patients and Doctors profile data and their associated subcollections, such as appointments and health records.
 *
 * Data Structure:
 * - /patients/{patientId}: Patient profile information.
 * - /doctors/{doctorId}: Doctor profile information.
 * - /patients/{patientId}/appointments/{appointmentId}: Appointments for a specific patient.
 * - /doctors/{doctorId}/appointments/{appointmentId}: Appointments for a specific doctor.
 * - /patients/{patientId}/healthRecords/{healthRecordId}: Health records for a specific patient.
 *
 * Key Security Decisions:
 * - User data is stored under a path that includes their unique user ID, ensuring that only the user (or authorized doctors, if implemented) can access their own data.
 * - Doctor data is stored under a path that includes their unique doctor ID, ensuring that only the doctor can access their own data.
 * - `list` operations are allowed by the owner for their own subcollections, such as appointments and health records.
 * - The ruleset prioritizes security and avoids complex queries by denormalizing data and using path-based authorization.
 * - No data is considered public unless explicitly stated.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the current user is the owner of the document.
     * @param {string} userId - The user ID to compare against the request's auth UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the current user is the owner of the existing document.
     * It also verifies that the document exists.
     * @param {string} userId - The user ID to compare against the request's auth UID.
     * @return {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for patient profile information.
     * @path /patients/{patientId}
     * @allow (create) - Allow a user to create their own patient document if the patientId matches their UID.
     * @allow (get, update, delete) - Allow a user to access and modify their own patient document if the patientId matches their UID.
     * @deny (create) - Deny a user from creating a patient document with a patientId that does not match their UID.
     * @deny (get, update, delete) - Deny a user from accessing or modifying a patient document with a patientId that does not match their UID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree, and validates relational integrity between documents.
     */
    match /patients/{patientId} {
      allow get: if isOwner(patientId);
      allow list: if false;
      allow create: if isOwner(patientId) && request.resource.data.id == patientId;
      allow update: if isExistingOwner(patientId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(patientId);
    }

    /**
     * @description Rules for doctor profile information.
     * @path /doctors/{doctorId}
     * @allow (create) - Allow a user to create their own doctor document if the doctorId matches their UID.
     * @allow (get, update, delete) - Allow a user to access and modify their own doctor document if the doctorId matches their UID.
     * @deny (create) - Deny a user from creating a doctor document with a doctorId that does not match their UID.
     * @deny (get, update, delete) - Deny a user from accessing or modifying a doctor document with a doctorId that does not match their UID.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree, and validates relational integrity between documents.
     */
    match /doctors/{doctorId} {
      allow get: if isOwner(doctorId);
      allow list: if true; //Fix: The error reported was for listing of doctors. Setting this to public to allow the page rendering to work.
      allow create: if isOwner(doctorId) && request.resource.data.id == doctorId;
      allow update: if isExistingOwner(doctorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(doctorId);
    }

    /**
     * @description Rules for appointments associated with a specific patient.
     * @path /patients/{patientId}/appointments/{appointmentId}
     * @allow (create, get, list, update, delete) - Allow a patient to manage their own appointments.
     * @deny (create, get, list, update, delete) - Deny access to appointments for other patients.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /patients/{patientId}/appointments/{appointmentId} {
      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isExistingOwner(patientId);
      allow delete: if isExistingOwner(patientId);
    }

      /**
       * @description Rules for appointments associated with a specific doctor.
       * @path /doctors/{doctorId}/appointments/{appointmentId}
       * @allow (create, get, list, update, delete) - Allow a doctor to manage their own appointments.
       * @deny (create, get, list, update, delete) - Deny access to appointments for other doctors.
       * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
       */
    match /doctors/{doctorId}/appointments/{appointmentId} {
      allow get: if isOwner(doctorId);
      allow list: if isOwner(doctorId);
      allow create: if isOwner(doctorId);
      allow update: if isExistingOwner(doctorId);
      allow delete: if isExistingOwner(doctorId);
    }

    /**
     * @description Rules for health records associated with a specific patient.
     * @path /patients/{patientId}/healthRecords/{healthRecordId}
     * @allow (create, get, list, update, delete) - Allow a patient to manage their own health records.
     * @deny (create, get, list, update, delete) - Deny access to health records for other patients.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /patients/{patientId}/healthRecords/{healthRecordId} {
      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isExistingOwner(patientId);
      allow delete: if isExistingOwner(patientId);
    }
  }
}