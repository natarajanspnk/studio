/**
 * @fileOverview
 * This ruleset enforces a strict user-ownership model for patient and doctor data,
 * allowing only authenticated users to access their own profile information.
 * Appointments and health records are organized as subcollections under patients and doctors,
 * with access restricted to the respective owner.
 * The 'calls' collection allows authenticated users to create or join a call for WebRTC signaling.
 *
 * Data Structure:
 * - /patients/{patientId}: Patient profile information.
 * - /doctors/{doctorId}: Doctor profile information.
 * - /patients/{patientId}/appointments/{appointmentId}: Appointments for a patient.
 * - /doctors/{doctorId}/appointments/{appointmentId}: Appointments for a doctor.
 * - /patients/{patientId}/healthRecords/{healthRecordId}: Health records for a patient.
 * - /calls/{callId}: WebRTC call signaling data.
 * - /calls/{callId}/offerCandidates/{candidateId}: ICE candidates from the caller.
 * - /calls/{callId}/answerCandidates/{candidateId}: ICE candidates from the callee.
 *
 * Key Security Decisions:
 * - Patients and doctors can only access their own profile data.
 * - Appointments and health records are accessible only by the associated patient or doctor.
 * - Listing of doctors is allowed for all authenticated users.
 * - The `calls` collection allows any authenticated user to create and modify call data.
 *
 * Denormalization for Authorization:
 * - The rules leverage the path structure (e.g., /patients/{patientId}) to directly
 *   infer ownership, avoiding the need for additional `get()` calls to determine authorization.
 *   In the cases of `Appointment` and `HealthRecord`, ownership (via `patientId` or `doctorId`)
 *   is implicitly denormalized by the parent path.
 *
 * Structural Segregation:
 * - The data is segregated into private user subcollections (e.g., /patients/{patientId}/appointments)
 *   to maintain strict access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows authenticated users to manage their own patient profile.
     * @path /patients/{patientId}
     * @allow (create) User with UID 'patient123' creates a new patient document with id 'patient123'.
     * @allow (get, update, delete) User with UID 'patient123' reads/updates/deletes their own patient document with id 'patient123'.
     * @deny (create) User with UID 'patient456' attempts to create a patient document with id 'patient123'.
     * @deny (get, update, delete) User with UID 'patient456' attempts to read/update/delete patient document with id 'patient123'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /patients/{patientId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(patientId);
      allow list: if false;
      allow create: if isOwner(patientId) && request.resource.data.id == patientId;
      allow update: if isExistingOwner(patientId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(patientId);
    }

    /**
     * @description Allows authenticated users to manage their own doctor profile.
     * @path /doctors/{doctorId}
     * @allow (create) User with UID 'doctor789' creates a new doctor document with id 'doctor789'.
     * @allow (get, update, delete) User with UID 'doctor789' reads/updates/deletes their own doctor document with id 'doctor789'.
     * @deny (create) User with UID 'patient123' attempts to create a doctor document with id 'doctor789'.
     * @deny (get, update, delete) User with UID 'patient123' attempts to read/update/delete doctor document with id 'doctor789'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /doctors/{doctorId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isOwner(doctorId) && request.resource.data.id == doctorId;
      allow update: if isExistingOwner(doctorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(doctorId);
    }

    /**
     * @description Allows authenticated users to manage appointments associated with their patient profile.
     * @path /patients/{patientId}/appointments/{appointmentId}
     * @allow (create) User with UID 'patient123' creates a new appointment document under their patient profile.
     * @allow (get, update, delete) User with UID 'patient123' reads/updates/deletes an appointment document under their patient profile.
     * @deny (create) User with UID 'doctor789' attempts to create an appointment document under patient 'patient123'.
     * @deny (get, update, delete) User with UID 'doctor789' attempts to read/update/delete an appointment document under patient 'patient123'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /patients/{patientId}/appointments/{appointmentId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get, list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isExistingOwner(patientId);
      allow delete: if isExistingOwner(patientId);
    }

    /**
     * @description Allows authenticated users to manage appointments associated with their doctor profile.
     * @path /doctors/{doctorId}/appointments/{appointmentId}
     * @allow (create) User with UID 'doctor789' creates a new appointment document under their doctor profile.
     * @allow (get, update, delete) User with UID 'doctor789' reads/updates/deletes an appointment document under their doctor profile.
     * @deny (create) User with UID 'patient123' attempts to create an appointment document under doctor 'doctor789'.
     * @deny (get, update, delete) User with UID 'patient123' attempts to read/update/delete an appointment document under doctor 'doctor789'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /doctors/{doctorId}/appointments/{appointmentId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get, list: if isOwner(doctorId);
      allow create: if isOwner(doctorId);
      allow update: if isExistingOwner(doctorId);
      allow delete: if isExistingOwner(doctorId);
    }

    /**
     * @description Allows authenticated users to manage health records associated with their patient profile.
     * @path /patients/{patientId}/healthRecords/{healthRecordId}
     * @allow (create) User with UID 'patient123' creates a new health record document under their patient profile.
     * @allow (get, update, delete) User with UID 'patient123' reads/updates/deletes a health record document under their patient profile.
     * @deny (create) User with UID 'doctor789' attempts to create a health record document under patient 'patient123'.
     * @deny (get, update, delete) User with UID 'doctor789' attempts to read/update/delete a health record document under patient 'patient123'.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /patients/{patientId}/healthRecords/{healthRecordId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get, list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isExistingOwner(patientId);
      allow delete: if isExistingOwner(patientId);
    }

    /**
     * @description Allows any authenticated user to create and modify call data.
     * @path /calls/{callId}
     * @allow (create, get, update, delete) Any authenticated user can create, read, update, or delete call data.
     * @principle Allows open access for authenticated users to facilitate call setup.
     */
    match /calls/{callId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to add offer ICE candidates to a call.
     * @path /calls/{callId}/offerCandidates/{candidateId}
     * @allow (create, get, update, delete) Any authenticated user can create, read, update, or delete offer ICE candidates.
     * @principle Allows open access for authenticated users to facilitate call setup.
     */
    match /calls/{callId}/offerCandidates/{candidateId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows any authenticated user to add answer ICE candidates to a call.
     * @path /calls/{callId}/answerCandidates/{candidateId}
     * @allow (create, get, update, delete) Any authenticated user can create, read, update, or delete answer ICE candidates.
     * @principle Allows open access for authenticated users to facilitate call setup.
     */
    match /calls/{callId}/answerCandidates/{candidateId} {
      allow get, list, create, update, delete: if isSignedIn();
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}