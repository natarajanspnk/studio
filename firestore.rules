rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines if a user is signed in
     */
    function isSignedIn() {
        return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource
     */
    function isOwner(resourceId) {
      return request.auth.uid == resourceId;
    }

    /**
     * @description Checks if the request is made by the owner of the resource and that the resource exists.
     */
    function isExistingOwner(resourceId) {
      return isOwner(resourceId) && exists(/databases/$(database)/documents/patients/$(resourceId));
    }

    /**
     * @description Rules for patient profile information.
     * @path /patients/{patientId}
     * @allow (create) User with UID 'patient123' can create their profile at /patients/patient123
     * @allow (get, update, delete) User with UID 'patient123' can access their profile at /patients/patient123
     * @deny (create) User with UID 'doctor456' cannot create a patient profile at /patients/patient123
     * @deny (get, update, delete) User with UID 'doctor456' cannot access patient data at /patients/patient123
     * @principle Enforces document ownership for writes. Restricts access to a user's own data tree.
     */
    match /patients/{patientId} {
      allow get: if isOwner(patientId);
      allow list: if false;
      allow create: if isOwner(patientId);
      allow update: if isOwner(patientId);
      allow delete: if isOwner(patientId);
    }

    /**
     * @description Rules for doctor profile information.
     * @path /doctors/{doctorId}
     * @allow (create) User with UID 'doctor456' can create their profile at /doctors/doctor456
     * @allow (get, update, delete) User with UID 'doctor456' can access their profile at /doctors/doctor456
     * @deny (create) User with UID 'patient123' cannot create a doctor profile at /doctors/doctor456
     * @deny (get, update, delete) User with UID 'patient123' cannot access doctor data at /doctors/doctor456
     * @principle Enforces document ownership for writes. Restricts access to a user's own data tree.
     */
    match /doctors/{doctorId} {
      allow get: if isOwner(doctorId);
      allow list: if false;
      allow create: if isOwner(doctorId);
      allow update: if isOwner(doctorId);
      allow delete: if isOwner(doctorId);
    }

    /**
     * @description Rules for appointments associated with a specific patient.
     * @path /patients/{patientId}/appointments/{appointmentId}
     * @allow (create) User with UID 'patient123' can create an appointment under /patients/patient123/appointments/appt1
     * @allow (get, update, delete) User with UID 'patient123' can access their appointments under /patients/patient123/appointments/appt1
     * @deny (create) User with UID 'doctor456' cannot create an appointment under /patients/patient123/appointments/appt1
     * @deny (get, update, delete) User with UID 'doctor456' cannot access patient appointments under /patients/patient123/appointments/appt1
     * @principle Enforces document ownership for writes. Restricts access to a user's own data tree.
     */
    match /patients/{patientId}/appointments/{appointmentId} {
      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isOwner(patientId);
      allow delete: if isOwner(patientId);
    }

    /**
     * @description Rules for appointments associated with a specific doctor.
     * @path /doctors/{doctorId}/appointments/{appointmentId}
     * @allow (create) User with UID 'doctor456' can create an appointment under /doctors/doctor456/appointments/appt1
     * @allow (get, update, delete) User with UID 'doctor456' can access their appointments under /doctors/doctor456/appointments/appt1
     * @deny (create) User with UID 'patient123' cannot create an appointment under /doctors/doctor456/appointments/appt1
     * @deny (get, update, delete) User with UID 'patient123' cannot access doctor appointments under /doctors/doctor456/appointments/appt1
     * @principle Enforces document ownership for writes. Restricts access to a user's own data tree.
     */
    match /doctors/{doctorId}/appointments/{appointmentId} {
      allow get: if isOwner(doctorId);
      allow list: if isOwner(doctorId);
      allow create: if isOwner(doctorId);
      allow update: if isOwner(doctorId);
      allow delete: if isOwner(doctorId);
    }

    /**
     * @description Rules for health records associated with a specific patient.
     * @path /patients/{patientId}/healthRecords/{healthRecordId}
     * @allow (create) User with UID 'patient123' can create a health record under /patients/patient123/healthRecords/record1
     * @allow (get, update, delete) User with UID 'patient123' can access their health records under /patients/patient123/healthRecords/record1
     * @deny (create) User with UID 'doctor456' cannot create a health record under /patients/patient123/healthRecords/record1
     * @deny (get, update, delete) User with UID 'doctor456' cannot access patient health records under /patients/patient123/healthRecords/record1
     * @principle Enforces document ownership for writes. Restricts access to a user's own data tree.
     */
    match /patients/{patientId}/healthRecords/{healthRecordId} {
      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isOwner(patientId);
      allow delete: if isOwner(patientId);
    }
  }
}