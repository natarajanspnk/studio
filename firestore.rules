/**
 * @fileOverview
 * This ruleset enforces a strict user-ownership model for patient and doctor profiles,
 * ensuring that only the authenticated user with the matching ID can access their own data.
 * Appointments and HealthRecords are secured under the respective patient and doctor profiles.
 * WebRTC call signaling data is accessible for any authenticated user.
 *
 * Data Structure:
 * - /patients/{patientId}: Patient profile information, accessible only by the patient.
 * - /doctors/{doctorId}: Doctor profile information, accessible only by the doctor.
 * - /patients/{patientId}/appointments/{appointmentId}: Appointments for a specific patient, accessible only by the patient.
 * - /doctors/{doctorId}/appointments/{appointmentId}: Appointments for a specific doctor, accessible only by the doctor.
 * - /patients/{patientId}/healthRecords/{healthRecordId}: Health records for a specific patient, accessible only by the patient.
 * - /calls/{callId}: WebRTC call signaling data, accessible by any authenticated user.
 * - /calls/{callId}/offerCandidates/{candidateId}: ICE candidates from the caller, accessible by any authenticated user.
 * - /calls/{callId}/answerCandidates/{candidateId}: ICE candidates from the callee, accessible by any authenticated user.
 *
 * Key Security Decisions:
 * - User listing is implicitly disallowed by the absence of a top-level /users collection.
 * - Ambiguous relationships default to the most secure interpretation: owner-only access.
 * - WebRTC signaling data is publicly accessible for authenticated users to facilitate call setup.
 *
 * Denormalization for Authorization:
 * - The subcollections patientId and doctorId are used to simplify security rules
 *   by avoiding the need for complex `get()` calls to verify ownership.
 *   Each subcollection inherits authorization context from its parent.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to patient profile information. Only the patient can access.
     * @path /patients/{patientId}
     * @allow (create) User abc can create their patient profile if request.auth.uid == 'abc'.
     * @allow (get, update, delete) User abc can get, update, or delete their patient profile if request.auth.uid == 'abc'.
     * @deny (create, get, update, delete) User xyz cannot create, get, update, or delete patient profile 'abc' because they are not authorized (request.auth.uid != 'abc').
     * @principle Enforces document ownership for writes.
     */
    match /patients/{patientId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(patientId);
      allow list: if false;
      allow create: if isOwner(patientId) && request.resource.data.id == request.auth.uid;
      allow update: if isOwner(patientId) && resource.data.id == patientId;
      allow delete: if isOwner(patientId) && resource.data.id == patientId;
    }

    /**
     * @description Controls access to doctor profile information. Only the doctor can access.
     * @path /doctors/{doctorId}
     * @allow (create) User abc can create their doctor profile if request.auth.uid == 'abc'.
     * @allow (get, update, delete) User abc can get, update, or delete their doctor profile if request.auth.uid == 'abc'.
     * @deny (create, get, update, delete) User xyz cannot create, get, update, or delete doctor profile 'abc' because they are not authorized (request.auth.uid != 'abc').
     * @principle Enforces document ownership for writes.
     */
    match /doctors/{doctorId} {
      function isOwner(doctorId) {
        return request.auth != null && request.auth.uid == doctorId;
      }
      allow get: if isOwner(doctorId);
      allow list: if false;
      allow create: if isOwner(doctorId) && request.resource.data.id == request.auth.uid;
      allow update: if isOwner(doctorId) && resource.data.id == doctorId;
      allow delete: if isOwner(doctorId) && resource.data.id == doctorId;
    }

    /**
     * @description Controls access to appointments associated with a specific patient. Only the patient can access.
     * @path /patients/{patientId}/appointments/{appointmentId}
     * @allow (create) User abc can create an appointment under their profile (patients/abc/...) if request.auth.uid == 'abc'.
     * @allow (get, update, delete) User abc can get, update, or delete an appointment under their profile (patients/abc/...) if request.auth.uid == 'abc'.
     * @deny (create, get, update, delete) User xyz cannot create, get, update, or delete an appointment under patient profile 'abc' because they are not authorized (request.auth.uid != 'abc').
     * @principle Enforces document ownership for writes and validates relational integrity.
     */
    match /patients/{patientId}/appointments/{appointmentId} {
      function isOwner(patientId) {
        return request.auth != null && request.auth.uid == patientId;
      }
      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isOwner(patientId);
      allow delete: if isOwner(patientId);
    }

    /**
     * @description Controls access to appointments associated with a specific doctor. Only the doctor can access.
     * @path /doctors/{doctorId}/appointments/{appointmentId}
     * @allow (create) User abc can create an appointment under their profile (doctors/abc/...) if request.auth.uid == 'abc'.
     * @allow (get, update, delete) User abc can get, update, or delete an appointment under their profile (doctors/abc/...) if request.auth.uid == 'abc'.
     * @deny (create, get, update, delete) User xyz cannot create, get, update, or delete an appointment under doctor profile 'abc' because they are not authorized (request.auth.uid != 'abc').
     * @principle Enforces document ownership for writes and validates relational integrity.
     */
    match /doctors/{doctorId}/appointments/{appointmentId} {
      function isOwner(doctorId) {
        return request.auth != null && request.auth.uid == doctorId;
      }
      allow get: if isOwner(doctorId);
      allow list: if isOwner(doctorId);
      allow create: if isOwner(doctorId);
      allow update: if isOwner(doctorId);
      allow delete: if isOwner(doctorId);
    }

    /**
     * @description Controls access to health records associated with a specific patient. Only the patient can access.
     * @path /patients/{patientId}/healthRecords/{healthRecordId}
     * @allow (create) User abc can create a health record under their profile (patients/abc/...) if request.auth.uid == 'abc'.
     * @allow (get, update, delete) User abc can get, update, or delete a health record under their profile (patients/abc/...) if request.auth.uid == 'abc'.
     * @deny (create, get, update, delete) User xyz cannot create, get, update, or delete a health record under patient profile 'abc' because they are not authorized (request.auth.uid != 'abc').
     * @principle Enforces document ownership for writes and validates relational integrity.
     */
    match /patients/{patientId}/healthRecords/{healthRecordId} {
      function isOwner(patientId) {
        return request.auth != null && request.auth.uid == patientId;
      }
      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isOwner(patientId);
      allow delete: if isOwner(patientId);
    }

    /**
     * @description Controls access to WebRTC signaling data for a video call. Any authenticated user can create or join a call.
     * @path /calls/{callId}
     * @allow (create, get, list, update, delete) Any authenticated user can perform any operation on the calls collection.
     * @principle Allows any authenticated user to access the calls collection.
     */
    match /calls/{callId} {
      function isSignedIn() {
          return request.auth != null;
      }
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to ICE candidates from the caller. Any authenticated user can add candidates.
     * @path /calls/{callId}/offerCandidates/{candidateId}
     * @allow (create, get, list, update, delete) Any authenticated user can perform any operation on the offerCandidates subcollection.
     * @principle Allows any authenticated user to access the offerCandidates subcollection.
     */
    match /calls/{callId}/offerCandidates/{candidateId} {
      function isSignedIn() {
          return request.auth != null;
      }
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to ICE candidates from the callee. Any authenticated user can add candidates.
     * @path /calls/{callId}/answerCandidates/{candidateId}
     * @allow (create, get, list, update, delete) Any authenticated user can perform any operation on the answerCandidates subcollection.
     * @principle Allows any authenticated user to access the answerCandidates subcollection.
     */
    match /calls/{callId}/answerCandidates/{candidateId} {
      function isSignedIn() {
          return request.auth != null;
      }
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }
  }
}