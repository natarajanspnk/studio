/**
 * @fileoverview Firestore Security Rules for MedConnect Platform
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for patient and doctor data,
 * ensuring that only authenticated users can access their own profile information.
 * It also provides controlled access to appointment and health record data based on user roles.
 * WebRTC signaling data for calls is accessible to any authenticated user.
 *
 * Data Structure:
 * - /patients/{patientId}: Stores patient profiles. Access is restricted to the owning patient.
 * - /doctors/{doctorId}: Stores doctor profiles. Access is restricted to the owning doctor.
 * - /patients/{patientId}/appointments/{appointmentId}: Stores appointments for a specific patient. Access is restricted to the owning patient.
 * - /doctors/{doctorId}/appointments/{appointmentId}: Stores appointments for a specific doctor. Access is restricted to the owning doctor.
 * - /patients/{patientId}/healthRecords/{healthRecordId}: Stores health records for a specific patient. Access is restricted to the owning patient.
 * - /calls/{callId}: Stores WebRTC call signaling data. Accessible to any authenticated user.
 * - /calls/{callId}/offerCandidates/{candidateId}: Stores offer ICE candidates. Accessible to any authenticated user.
 * - /calls/{callId}/answerCandidates/{candidateId}: Stores answer ICE candidates. Accessible to any authenticated user.
 *
 * Key Security Decisions:
 * - User listing is disallowed for both patients and doctors.
 * - The ruleset prioritizes simplicity and performance by avoiding `get()` calls.
 * - WebRTC signaling data is publicly accessible to authenticated users to facilitate call setup.
 * - Doctor listing is public.
 *
 * Denormalization for Authorization:
 * - None. Ownership is implied by the path for profile and appointment data.
 *
 * Structural Segregation:
 * - Private patient and doctor profile data are stored under user-specific paths.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Defines the isSignedIn function.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Defines the isOwner function.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Defines the isExistingOwner function.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for patient profiles.
     * @path /patients/{patientId}
     * @allow (create) If the authenticated user's UID matches the patientId.
     * @allow (get, update, delete) If the authenticated user's UID matches the patientId.
     * @deny (create) If the authenticated user's UID does not match the patientId.
     * @deny (get, update, delete) If the authenticated user's UID does not match the patientId.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree, and validates relational integrity between documents.
     */
    match /patients/{patientId} {
      allow get: if isOwner(patientId);
      allow list: if false;
      allow create: if isOwner(patientId) && request.resource.data.id == patientId;
      allow update: if isExistingOwner(patientId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(patientId);
    }

    /**
     * @description Rules for doctor profiles.
     * @path /doctors/{doctorId}
     * @allow (create) If the authenticated user's UID matches the doctorId.
     * @allow (get, update, delete) If the authenticated user's UID matches the doctorId.
     * @deny (create) If the authenticated user's UID does not match the doctorId.
     * @deny (get, update, delete) If the authenticated user's UID does not match the doctorId.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree, and validates relational integrity between documents.
     */
    match /doctors/{doctorId} {
      allow get: if true; //Doctors are public, to allow listing
      allow list: if true;
      allow create: if isOwner(doctorId) && request.resource.data.id == doctorId;
      allow update: if isExistingOwner(doctorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(doctorId);
    }

    /**
     * @description Rules for appointments under a patient.
     * @path /patients/{patientId}/appointments/{appointmentId}
     * @allow (create) If the authenticated user's UID matches the patientId.
     * @allow (get, update, delete) If the authenticated user's UID matches the patientId.
     * @deny (create) If the authenticated user's UID does not match the patientId.
     * @deny (get, update, delete) If the authenticated user's UID does not match the patientId.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /patients/{patientId}/appointments/{appointmentId} {
      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isOwner(patientId) && resource != null;
      allow delete: if isOwner(patientId) && resource != null;
    }

     /**
     * @description Rules for appointments under a doctor.
     * @path /doctors/{doctorId}/appointments/{appointmentId}
     * @allow (create) If the authenticated user's UID matches the doctorId.
     * @allow (get, update, delete) If the authenticated user's UID matches the doctorId.
     * @deny (create) If the authenticated user's UID does not match the doctorId.
     * @deny (get, update, delete) If the authenticated user's UID does not match the doctorId.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /doctors/{doctorId}/appointments/{appointmentId} {
      allow get: if isOwner(doctorId);
      allow list: if isOwner(doctorId);
      allow create: if isOwner(doctorId);
      allow update: if isOwner(doctorId) && resource != null;
      allow delete: if isOwner(doctorId) && resource != null;
    }

    /**
     * @description Rules for health records under a patient.
     * @path /patients/{patientId}/healthRecords/{healthRecordId}
     * @allow (create) If the authenticated user's UID matches the patientId.
     * @allow (get, update, delete) If the authenticated user's UID matches the patientId.
     * @deny (create) If the authenticated user's UID does not match the patientId.
     * @deny (get, update, delete) If the authenticated user's UID does not match the patientId.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /patients/{patientId}/healthRecords/{healthRecordId} {
      allow get: if isOwner(patientId);
      allow list: if isOwner(patientId);
      allow create: if isOwner(patientId);
      allow update: if isOwner(patientId) && resource != null;
      allow delete: if isOwner(patientId) && resource != null;
    }

    /**
     * @description Rules for calls.
     * @path /calls/{callId}
     * @allow (create, get, list, update, delete) Any authenticated user can access.
     */
    match /calls/{callId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for offer candidates.
     * @path /calls/{callId}/offerCandidates/{candidateId}
     * @allow (create, get, list, update, delete) Any authenticated user can access.
     */
    match /calls/{callId}/offerCandidates/{candidateId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Rules for answer candidates.
     * @path /calls/{callId}/answerCandidates/{candidateId}
     * @allow (create, get, list, update, delete) Any authenticated user can access.
     */
    match /calls/{callId}/answerCandidates/{candidateId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }
}