/**
 * @fileoverview Firestore Security Rules for MedConnect Platform
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for patient and doctor data,
 * ensuring that only authenticated users can access their own profile information.
 * Appointments and health records are organized as subcollections under patients and doctors
 * to facilitate efficient querying and maintain data privacy.
 * WebRTC signaling data in the `calls` collection is accessible to any authenticated user
 * to enable call setup.
 *
 * Data Structure:
 * - /patients/{patientId}: Stores patient profile information.
 * - /doctors/{doctorId}: Stores doctor profile information.
 * - /patients/{patientId}/appointments/{appointmentId}: Stores appointments for a patient.
 * - /doctors/{doctorId}/appointments/{appointmentId}: Stores appointments for a doctor.
 * - /patients/{patientId}/healthRecords/{healthRecordId}: Stores health records for a patient.
 * - /calls/{callId}: Stores WebRTC signaling data for a video call.
 * - /calls/{callId}/offerCandidates/{candidateId}: ICE candidates from the caller.
 * - /calls/{callId}/answerCandidates/{candidateId}: ICE candidates from the callee.
 *
 * Key Security Decisions:
 * - Users can only access their own patient or doctor profile.
 * - Read access to the list of doctors is granted to all users (including unauthenticated users) to allow browsing available doctors.
 * - Appointments and health records are accessible only to the associated patient or doctor.
 * - WebRTC signaling data in the `calls` collection is accessible to any authenticated user.
 * - Data consistency between the path and document data is enforced on create and update operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows authenticated users to read doctor profiles and doctors to manage their own profiles.
     * @path /doctors/{doctorId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn() && isOwner(doctorId)
     * @deny (create, update, delete) if !isSignedIn() || !isOwner(doctorId)
     * @principle Enforces doctor-ownership for profile management. Allows public read access.
     */
    match /doctors/{doctorId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && isOwner(doctorId);
      allow update: if isSignedIn() && isExistingOwner(doctorId);
      allow delete: if isSignedIn() && isExistingOwner(doctorId);
    }

    /**
     * @description Allows authenticated users to manage their own patient profiles.
     * @path /patients/{patientId}
     * @allow (create, get, update, delete, list) if isSignedIn() && isOwner(patientId)
     * @deny (create, get, update, delete, list) if !isSignedIn() || !isOwner(patientId)
     * @principle Enforces patient-ownership for profile management.
     */
    match /patients/{patientId} {
      allow get: if isSignedIn() && isOwner(patientId);
      allow list: if isSignedIn() && isOwner(patientId);
      allow create: if isSignedIn() && isOwner(patientId) && request.resource.data.id == patientId;
      allow update: if isSignedIn() && isExistingOwner(patientId) && request.resource.data.id == resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(patientId);

      /**
       * @description Allows authenticated patients to manage their appointments.
       * @path /patients/{patientId}/appointments/{appointmentId}
       * @allow (create, get, update, delete, list) if isSignedIn() && isOwner(patientId)
       * @deny (create, get, update, delete, list) if !isSignedIn() || !isOwner(patientId)
       * @principle Enforces patient-ownership for appointment management.
       */
      match /appointments/{appointmentId} {
        allow get: if isSignedIn() && isOwner(patientId);
        allow list: if isSignedIn() && isOwner(patientId);
        allow create: if isSignedIn() && isOwner(patientId);
        allow update: if isSignedIn() && isExistingOwner(patientId);
        allow delete: if isSignedIn() && isExistingOwner(patientId);
      }

      /**
       * @description Allows authenticated patients to manage their health records.
       * @path /patients/{patientId}/healthRecords/{healthRecordId}
       * @allow (create, get, update, delete, list) if isSignedIn() && isOwner(patientId)
       * @deny (create, get, update, delete, list) if !isSignedIn() || !isOwner(patientId)
       * @principle Enforces patient-ownership for health record management.
       */
      match /healthRecords/{healthRecordId} {
        allow get: if isSignedIn() && isOwner(patientId);
        allow list: if isSignedIn() && isOwner(patientId);
        allow create: if isSignedIn() && isOwner(patientId);
        allow update: if isSignedIn() && isExistingOwner(patientId);
        allow delete: if isSignedIn() && isExistingOwner(patientId);
      }
    }

    /**
     * @description Allows authenticated doctors to manage their appointments.
     * @path /doctors/{doctorId}/appointments/{appointmentId}
     * @allow (create, get, update, delete, list) if isSignedIn() && isOwner(doctorId)
     * @deny (create, get, update, delete, list) if !isSignedIn() || !isOwner(doctorId)
     * @principle Enforces doctor-ownership for appointment management.
     */
    match /doctors/{doctorId}/appointments/{appointmentId} {
      allow get: if isSignedIn() && isOwner(doctorId);
      allow list: if isSignedIn() && isOwner(doctorId);
      allow create: if isSignedIn() && isOwner(doctorId);
      allow update: if isSignedIn() && isExistingOwner(doctorId);
      allow delete: if isSignedIn() && isExistingOwner(doctorId);
    }

    /**
     * @description Allows any authenticated user to create or join a call.
     * @path /calls/{callId}
     * @allow (create, get, update, delete, list) if isSignedIn()
     * @deny (create, get, update, delete, list) if !isSignedIn()
     * @principle Allows any authenticated user to create or join a call.
     */
    match /calls/{callId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;

      /**
       * @description Allows any authenticated user to add ICE candidates from the caller.
       * @path /calls/{callId}/offerCandidates/{candidateId}
       * @allow (create, get, update, delete, list) if isSignedIn()
       * @deny (create, get, update, delete, list) if !isSignedIn()
       * @principle Allows any authenticated user to add ICE candidates from the caller.
       */
      match /offerCandidates/{candidateId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }

      /**
       * @description Allows any authenticated user to add ICE candidates from the callee.
       * @path /calls/{callId}/answerCandidates/{candidateId}
       * @allow (create, get, update, delete, list) if isSignedIn()
       * @deny (create, get, update, delete, list) if !isSignedIn()
       * @principle Allows any authenticated user to add ICE candidates from the callee.
       */
      match /answerCandidates/{candidateId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
      }
    }
  }

  // Helper function to determine if the user is signed in
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner
  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  // Helper function to determine if the user is the owner and the document exists
  function isExistingOwner(userId) {
    return isSignedIn() && isOwner(userId) && resource != null;
  }
}